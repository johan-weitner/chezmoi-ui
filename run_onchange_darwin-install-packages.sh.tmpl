{{ if eq .chezmoi.os "darwin" -}}
#!/bin/bash

echo ".................    ....:::::::::......  ..................
.............   ..:::----------------:::....   .............
...........  ..:---==-:..   ..   ...        ...  ...........
........  .:=+=+===:.                       ..::............
....... .-+****++=.                            .............
.....  -+*******=.                                  ........
.... .+********-.                                     ......
... :*********-                                        .....
.. -**********:                           . ..          ....
. :***********:                       .---=-----:.        ..
 .************:                     . :+**+==-----:    ..:..
 =*+**********:                      :+*++**+=+----.  .---.
.*************-                   ..-+*++++++**=--=:   :--:
-*************+        ....       -**********+===-:... .---.
-*************+:      :=++=--:.: :+**=:::::::::...      :--.
-**************+.    .-=+*****+-=**+*:                  .--.
-***************=.    .--+*++*****++*-:::::.. .:::.  ...:--.
:***************+.     :--++**++**********+---+**#*: .-=---
 =**************+:   .------=**+******+++++=+=-+****: .---.
 :****************+: -----+=-=+**+***********=-=++==:  :=: .
. -***************+.:--==+++--=++**********+++==--:  :---. .
.. -***********+*=.:--+*****=----+***+******+=:... .:---. ..
... -**++==+**+*+.:--+*******=----=+****+*+*+=-:   .---. ...
.... .:..:+#*+#%=-----==+****+------==++*****==:  :--:. ....
.....   *@@%%#%%+=++=--=+*****+=---:..:---=+++-.  :-. ......
........:+%@@%%%****+++*******+=--=-:+#+==-. .       .......
........  .=#%@@#+++*********=-==++-=#%%****=.   ...........
..........   :=*%#***********++***-=#%%%%*+**: .............
.............   .--=++************+#%%#*+-..  ..............
................    ...::--=====----::.    ................. bootstrap.mac"
echo ""

echo "Installing prerequisites"
echo ""
if ! which xcodeinstall &> /dev/null; then
echo "Installing XCode..."
brew install sebsto/macos/xcodeinstall
fi

brew update

echo ""
echo "Installing Homebrew packages..."
brew bundle --no-lock --file=/dev/stdin <<EOF
{{ range .packages.darwin.brews -}}
brew {{ . | quote }}
{{ end -}}
{{ range .packages.darwin.casks -}}
cask {{ . | quote }}
{{ end -}}
EOF
{{ end -}}



echo ""
echo "Installing binary images..."
{{ range $app, $binary := .packages.darwin.binaryMac -}}
echo "Downloading {{ $binary.name }} from {{ $binary.url }}"
curl -sL {{ $binary.url }} -o {{ $binary.name }} -o '{{ $binary.name }}'

echo "Mounting {{ $binary.name }}"
volume=$(hdiutil attach "{{ $binary.name }}" | grep '/Volumes/' | awk '{ print $3 }')

echo "Volume: $volume"

app_path=$(find "$volume" -name "*.app" -maxdepth 1)
echo "App path: $app_path"

if [ -n "$app_path" ]; then
    echo "Copying $app_path to /Applications"
    cp -R "$app_path" /Applications/
else
    echo "No .app file found in $volume"
    ls -l $volume
fi

echo "Unmounting $volume"
hdiutil detach "$volume"

rm "{{ $binary.name }}"

{{ end -}}



echo ""
echo "Installing packages by shellscript..."
{{ range .packages.darwin.scripts -}}
if ! which {{ . | quote }} &> /dev/null; then
  sh -c "$(curl -fsSL {{ . | quote }})"
else
  echo "{{ . | quote }} already installed - skipping"
fi
{{ end -}}


echo ""
echo "Setting up Node and PNPM..."
if ! which node &> /dev/null; then
  echo "Installing Node LTS..."
  volta install node
else
  echo "Node already installed at version $(node -v)"
fi

if ! which pnpm &> /dev/null; then
  echo "Installing PNPM..."
  volta install pnpm
else
  echo "PNPM already installed at version $(pnpm -v)"
fi

echo ""
echo "Installing NPM packages..."
{{ range $ix, $app := .packages.darwin.node -}}
if ! which {{ $app.name }} &> /dev/null; then
echo "Downloading {{ $app.pkg }}..."
pnpm add -g {{ $app.pkg }}
fi
{{ end -}}

echo ""
echo "Installing cargo packages..."
{{ range .packages.darwin.cargo -}}
if ! which {{ . | quote }} &> /dev/null; then
  echo "Installing {{ . | quote }}..."
  cargo install "{{ . | quote }}"
else
  echo "{{ . | quote }} already installed - skipping"
fi
{{ end -}}


echo ""
echo "Fetching Git repos..."
{{ range .packages.darwin.git -}}
if ! which {{ . | quote }} &> /dev/null; then
  echo "Installing {{ . | quote }}..."
  git clone "{{ . | quote }}"
else
  echo "{{ . | quote }} already installed - skipping"
fi
{{ end -}}


# echo""
# echo  "Installing Go repos..."
# {{ range .packages.darwin.go -}}
# if ! which {{ . | quote }} &> /dev/null; then
#   echo "Installing {{ . | quote }}..."
#   go install "{{ . | quote }}"
# else
#   echo "{{ . | quote }} already installed - skipping"
# fi
# {{ end -}}

echo ""
echo "Installing packages by pip..."
{{ range .packages.darwin.pip -}}
if ! which {{ . | quote }} &> /dev/null; then
  pip install {{ . | quote }}
else
  echo "{{ . | quote }} already installed - skipping"
fi
{{ end -}}

echo ""
echo "Installing packages by pipx..."
{{ range .packages.darwin.pipx -}}
if ! which {{ . | quote }} &> /dev/null; then
  pipx install {{ . | quote }}
else
  echo "{{ . | quote }} already installed - skipping"
fi
{{ end -}}