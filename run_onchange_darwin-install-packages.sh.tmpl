{{ if eq .chezmoi.os "darwin" -}}
#!/bin/bash

echo ".................    ....:::::::::......  ..................
.............   ..:::----------------:::....   .............
...........  ..:---==-:..   ..   ...        ...  ...........
........  .:=+=+===:.                       ..::............
....... .-+****++=.                            .............
.....  -+*******=.                                  ........
.... .+********-.                                     ......
... :*********-                                        .....
.. -**********:                           . ..          ....
. :***********:                       .---=-----:.        ..
 .************:                     . :+**+==-----:    ..:..
 =*+**********:                      :+*++**+=+----.  .---.
.*************-                   ..-+*++++++**=--=:   :--:
-*************+        ....       -**********+===-:... .---.
-*************+:      :=++=--:.: :+**=:::::::::...      :--.
-**************+.    .-=+*****+-=**+*:                  .--.
-***************=.    .--+*++*****++*-:::::.. .:::.  ...:--.
:***************+.     :--++**++**********+---+**#*: .-=---
 =**************+:   .------=**+******+++++=+=-+****: .---.
 :****************+: -----+=-=+**+***********=-=++==:  :=: .
. -***************+.:--==+++--=++**********+++==--:  :---. .
.. -***********+*=.:--+*****=----+***+******+=:... .:---. ..
... -**++==+**+*+.:--+*******=----=+****+*+*+=-:   .---. ...
.... .:..:+#*+#%=-----==+****+------==++*****==:  :--:. ....
.....   *@@%%#%%+=++=--=+*****+=---:..:---=+++-.  :-. ......
........:+%@@%%%****+++*******+=--=-:+#+==-. .       .......
........  .=#%@@#+++*********=-==++-=#%%****=.   ...........
..........   :=*%#***********++***-=#%%%%*+**: .............
.............   .--=++************+#%%#*+-..  ..............
................    ...::--=====----::.    ................. install.mac"
echo ""

echo "Installing prerequisites"
echo ""
if ! which xcodeinstall &> /dev/null; then
echo "Installing XCode..."
brew install sebsto/macos/xcodeinstall
fi

brew update

echo ""
echo "Installing Homebrew packages..."
brew bundle --no-lock --file=/dev/stdin <<EOF
{{ range .packages.darwin.brews -}}
brew {{ . | quote }}
{{ end -}}
{{ range .packages.darwin.casks -}}
cask {{ . | quote }}
{{ end -}}
EOF
{{ end -}}



echo ""
echo "Installing binary images..."
{{ range $app, $binary := .packages.darwin.binaryMac -}}
if [ -d /Applications/{{ $binary.name }} ]; then
  echo "{{ $binary.name }} already installed. Skipping..."
else
  echo "Downloading {{ $binary.dmg }} from {{ $binary.url }}"
  curl -sL {{ $binary.url }} -o {{ $binary.dmg }}

  echo "Mounting {{ $binary.dmg }}"
  volume=$(hdiutil attach "{{ $binary.dmg }}" | grep '/Volumes/' | awk '{ print $3 }')

  app_path=$(find "$volume" -name "*.app" -maxdepth 1)
  echo "App path: $app_path"

  if [ -n "$app_path" ]; then
      echo "Copying $app_path to /Applications"
      cp -R "$app_path" /Applications/
  else
      echo "No .app file found in $volume"
      ls -l $volume
  fi

  echo "Unmounting $volume"
  hdiutil detach "$volume"
  rm "{{ $binary.dmg }}"
fi

{{ end -}}



echo ""
echo "Installing packages by shellscript..."
{{ range .packages.darwin.scripts -}}
if ! which {{ . | quote }} &> /dev/null; then
  sh -c "$(curl -fsSL {{ . | quote }})"
else
  echo "{{ . | quote }} already installed - skipping"
fi
{{ end -}}

echo ""
echo ""
echo "Setting up Node and PNPM..."
if ! which node &> /dev/null; then
  echo "Installing Node LTS..."
  volta install node
else
  echo "Node already installed at version $(node -v)"
fi

if ! which pnpm &> /dev/null; then
  echo "Installing PNPM..."
  volta install pnpm
else
  echo "PNPM already installed at version $(pnpm -v)"
fi

echo ""
echo "Installing NPM packages..."
empty=true
{{ range $ix, $app := .packages.darwin.node -}}
if ! which {{ $app.name }} &> /dev/null; then
empty=false
echo "Downloading {{ $app.pkg }}..."
pnpm add -g {{ $app.pkg }}
fi
if $empty; echo "All NPM packages already installed." fi
{{ end -}}

echo ""
echo "Installing cargo packages..."
{{ range .packages.darwin.cargo -}}
if ! which {{ . | quote }} &> /dev/null; then
empty=false
  echo "Installing {{ . | quote }}..."
  cargo install "{{ . | quote }}"
else
  echo "{{ . | quote }} already installed - skipping"
fi
if $empty; echo "All Cargo packages already installed."
{{ end -}}


echo ""
echo "Fetching Git repos..."
empty=true
{{ range .packages.darwin.git -}}
if ! which {{ . | quote }} &> /dev/null; then
empty=false
  echo "Installing {{ . | quote }}..."
  git clone "{{ . | quote }}"
else
  echo "{{ . | quote }} already installed - skipping"
fi
if $empty; echo "All Git repos already installed."
{{ end -}}


# echo""
# echo  "Installing Go repos..."
empty=true
# {{ range .packages.darwin.go -}}
# if ! which {{ . | quote }} &> /dev/null; then
# empty=false
#   echo "Installing {{ . | quote }}..."
#   go install "{{ . | quote }}"
# else
#   echo "{{ . | quote }} already installed - skipping"
# fi
# if $empty; echo "All Go repos already installed."
# {{ end -}}

echo ""
echo "Installing packages by pip..."
empty=true
{{ range .packages.darwin.pip -}}
if ! which {{ . | quote }} &> /dev/null; then
  empty=false
  pip install {{ . | quote }}
else
  echo "{{ . | quote }} already installed - skipping"
pip
if $empty; echo "All NPM packages already installed."
{{ end -}}

echo ""
echo "Installing packages by pipx..."
empty=true
{{ range .packages.darwin.pipx -}}
if ! which {{ . | quote }} &> /dev/null; then
  empty=false
  pipx install {{ . | quote }}
else
  echo "{{ . | quote }} already installed - skipping"
fi
if $empty; echo "All pipx packages already installed."
{{ end -}}

source ~/.zshrc